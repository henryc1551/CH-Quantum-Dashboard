<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0d6efd"/>
  <title>Quantum Dashboard Pro</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" href="/favicon.ico">
  <style>
    :root{--bg:#0b0b0c;--fg:#e7e7ec;--muted:#9aa0a6;--acc:#0d6efd;--card:#141417}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .brand img{width:28px;height:28px;border-radius:8px}
    .pill{background:#0f0f12;border:1px solid #26262b;padding:6px 10px;border-radius:999px;color:var(--muted)}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 12;background:var(--card);border:1px solid #26262b;border-radius:14px;padding:14px}
    @media(min-width:900px){.card.half{grid-column:span 6}}
    button,.btn{background:var(--acc);color:#fff;border:0;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.sec{background:#1f1f25;color:var(--fg);border:1px solid #2b2b33}
    input,textarea{width:100%;background:#101014;color:var(--fg);border:1px solid #26262b;border-radius:10px;padding:10px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    pre{background:#0f0f12;border:1px solid #26262b;border-radius:10px;padding:10px;overflow:auto;max-height:220px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="/logo-192.png" alt="QD">
        <strong>Quantum Dashboard</strong>
        <span id="ver" class="pill">v?</span>
      </div>
      <div class="row">
        <button id="logout" class="btn sec">Wyloguj</button>
        <button id="install" class="btn sec">Zainstaluj PWA</button>
      </div>
    </header>

    <div id="lock" class="card">
      <h3>Wej≈õcie</h3>
      <p>Has≈Ço ekranu (UI): <code>przyja≈∫≈Ñ</code></p>
      <div class="row">
        <input id="pw" type="password" placeholder="has≈Ço‚Ä¶"/>
        <button id="go">Wejd≈∫</button>
      </div>
      <small class="muted">Uwaga: to tylko blokada UI. G≈Ç√≥wne uwierzytelnianie: cookie z parametru <code>?token=‚Ä¶</code>.</small>
    </div>

    <div id="app" class="hidden">
      <div class="grid">
        <section class="card half">
          <h3>üì¶ Projekty</h3>
          <div class="row">
            <input id="entry" placeholder="URL projektu (entry)‚Ä¶">
            <button id="add">Dodaj</button>
            <button id="sync">üîÅ Sync z KV</button>
            <button id="export">‚¨áÔ∏è Export JSON</button>
            <input id="importFile" type="file" accept="application/json" class="hidden">
            <button id="import">‚¨ÜÔ∏è Import JSON</button>
          </div>
          <div id="list"></div>
        </section>

        <section class="card half">
          <h3>üß∞ Akcje (asystent)</h3>
          <div class="row">
            <input id="verifyUrl" placeholder="https://‚Ä¶ (HEAD)">
            <button id="verifyBtn">Sprawd≈∫ HEAD</button>
          </div>
          <div class="row">
            <input id="hookUrl" placeholder="Webhook URL (deploy/CI)">
            <input id="hookSecret" placeholder="Sekretny nag≈Ç√≥wek (opcjonalnie)">
            <button id="hookBtn">Wy≈õlij webhook</button>
          </div>
          <pre id="assistLog"></pre>
        </section>

        <section class="card">
          <h3>üí¨ Chat (demo pamiƒôci)</h3>
          <div class="row">
            <input id="msg" placeholder="Wpisz wiadomo≈õƒá i ENTER">
            <button id="saveChat">Zapisz do KV</button>
            <button id="loadChat">Wczytaj z KV</button>
          </div>
          <pre id="log"></pre>
        </section>
      </div>
    </div>
  </div>

  <script>
    // PWA
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js").catch(()=>{});
    }
    let deferredPrompt=null;
    window.addEventListener("beforeinstallprompt",(e)=>{ e.preventDefault(); deferredPrompt=e; });
    document.getElementById("install").onclick=async()=>{
      if(!deferredPrompt) return alert("PWA ju≈º zainstalowana lub niedostƒôpna");
      deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;
    };

    // wersja / health
    fetch("/version").then(r=>r.json()).then(v=>{
      document.getElementById("ver").textContent = "v"+(v.version||"?");
    });

    // UI lock
    const lock = document.getElementById("lock");
    const app  = document.getElementById("app");
    const go = document.getElementById("go");
    const pw = document.getElementById("pw");
    function openIfOk(){
      if (pw.value.trim() === "przyja≈∫≈Ñ") {
        lock.classList.add("hidden"); app.classList.remove("hidden");
        localStorage.setItem("qdp-ui-ok","1");
      } else { alert("Z≈Çe has≈Ço (podpowied≈∫: przyja≈∫≈Ñ)"); }
    }
    go.onclick=openIfOk; pw.onkeydown=(e)=>{ if(e.key==="Enter") openIfOk(); };
    if (localStorage.getItem("qdp-ui-ok")==="1") { lock.classList.add("hidden"); app.classList.remove("hidden"); }

    // wylogowanie (czy≈õci lokalnƒÖ zas≈Çonƒô UI)
    document.getElementById("logout").onclick=()=>{
      localStorage.removeItem("qdp-ui-ok"); location.reload();
    };

    // PROJEKTY ‚Äì import/export/sync
    const list = document.getElementById("list");
    const entry = document.getElementById("entry");
    let projects = [];

    function render() {
      list.innerHTML = "";
      projects.forEach((p,i)=>{
        const row = document.createElement("div");
        row.className="row";
        row.innerHTML = `
          <span class="pill">${p.name||"Bez nazwy"}</span>
          <a class="btn sec" href="${p.entry}" target="_blank">‚ñ∂ Otw√≥rz</a>
          <button class="btn sec" data-i="${i}" data-act="edit">‚úèÔ∏è</button>
          <button class="btn sec" data-i="${i}" data-act="del">üóëÔ∏è</button>
        `;
        list.appendChild(row);
      });
    }

    function saveLocal() { localStorage.setItem("qdp-projects", JSON.stringify(projects)); }
    function loadLocal() { projects = JSON.parse(localStorage.getItem("qdp-projects")||"[]"); render(); }
    loadLocal();

    document.getElementById("add").onclick=()=>{
      const url = entry.value.trim(); if(!url) return;
      projects.push({ name: "Custom", entry: url, category: "app", ts: Date.now() });
      entry.value = ""; saveLocal(); render();
    };
    list.onclick=(e)=>{
      const btn = e.target.closest("button"); if(!btn) return;
      const i = +btn.dataset.i, act = btn.dataset.act;
      if (act==="del") { projects.splice(i,1); saveLocal(); render(); }
      if (act==="edit") {
        const np = prompt("Nazwa projektu:", projects[i].name||"");
        if (np!=null) { projects[i].name=np; saveLocal(); render(); }
      }
    };
    document.getElementById("export").onclick=()=>{
      const a=document.createElement("a");
      a.href="data:application/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(projects,null,2));
      a.download="projects.json"; a.click();
    };
    const importFile = document.getElementById("importFile");
    document.getElementById("import").onclick=()=>importFile.click();
    importFile.onchange=async()=>{
      const file = importFile.files[0]; if(!file) return;
      const txt = await file.text(); projects = JSON.parse(txt); saveLocal(); render();
    };
    document.getElementById("sync").onclick=async()=>{
      // zapis do KV
      const r = await fetch("/api/kv/projects", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify(projects) });
      if (!r.ok) return alert("KV sync: b≈ÇƒÖd (czy wszed≈Çe≈õ przez ?token=...?)");
      alert("Zsynchronizowano z KV");
    };
    // wczytanie z KV (je≈õli istnieje)
    (async()=>{
      const r = await fetch("/api/kv/projects"); if(r.ok){
        const j = await r.json(); if (j && j.value) { projects = j.value; saveLocal(); render(); }
      }
    })();

    // CHAT demo (KV)
    const log = document.getElementById("log");
    const msg = document.getElementById("msg");
    const chat = JSON.parse(localStorage.getItem("qdp-chat")||"[]");
    function renderChat(){ log.textContent = chat.map(x=>`‚Ä¢ ${new Date(x.t).toLocaleTimeString()}  ${x.m}`).join("\n"); }
    renderChat();
    msg.onkeydown=(e)=>{ if(e.key==="Enter"){ chat.push({t:Date.now(), m:msg.value}); msg.value=""; localStorage.setItem("qdp-chat",JSON.stringify(chat)); renderChat(); } };
    document.getElementById("saveChat").onclick=async()=>{
      const r = await fetch("/api/kv/chat", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify(chat) });
      alert(r.ok ? "Zapisano do KV" : "B≈ÇƒÖd KV (wejd≈∫ przez ?token=‚Ä¶)");
    };
    document.getElementById("loadChat").onclick=async()=>{
      const r = await fetch("/api/kv/chat"); const j = await r.json();
      if (j && j.value) { localStorage.setItem("qdp-chat",JSON.stringify(j.value)); location.reload(); }
      else alert("Brak czatu w KV");
    };

    // Asystent ‚Äì akcje
    const assistLog = document.getElementById("assistLog");
    function logAssist(x){ assistLog.textContent = (typeof x==="string")? x : JSON.stringify(x,null,2); }
    document.getElementById("verifyBtn").onclick=async()=>{
      const url = document.getElementById("verifyUrl").value.trim(); if(!url) return;
      const r = await fetch("/api/assist/run", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ action:"projects.verifyHead", params:{ url } }) });
      logAssist(await r.json());
    };
    document.getElementById("hookBtn").onclick=async()=>{
      const url = document.getElementById("hookUrl").value.trim();
      const secret = document.getElementById("hookSecret").value.trim();
      if(!url) return;
      const r = await fetch("/api/assist/run", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ action:"deploy.webhook", params:{ url, secret } }) });
      logAssist(await r.json());
    };
  </script>
</body>
</html>
