<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0d6efd"/>
  <title>Quantum Dashboard Pro</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" href="/favicon.ico">
  <style>
    :root{--bg:#0b0b0c;--fg:#e7e7ec;--muted:#9aa0a6;--acc:#0d6efd;--card:#141417}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:10px;align-items:center}
    .brand img{width:28px;height:28px;border-radius:8px}
    .pill{background:#0f0f12;border:1px solid #26262b;padding:6px 10px;border-radius:999px;color:var(--muted)}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 12;background:var(--card);border:1px solid #26262b;border-radius:14px;padding:14px}
    @media(min-width:900px){.card.half{grid-column:span 6}}
    button,.btn{background:var(--acc);color:#fff;border:0;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.sec{background:#1f1f25;color:var(--fg);border:1px solid #2b2b33}
    input,textarea,select{width:100%;background:#101014;color:var(--fg);border:1px solid #26262b;border-radius:10px;padding:10px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    pre{background:#0f0f12;border:1px solid #26262b;border-radius:10px;padding:10px;overflow:auto;max-height:260px;white-space:pre-wrap}
    .hidden{display:none}
    .chatlog{max-height:420px;overflow:auto;background:#0f0f12;border:1px solid #26262b;border-radius:10px;padding:10px}
    .msg{margin:6px 0;padding:8px 10px;border-radius:10px}
    .user{background:#1f2533}
    .assistant{background:#1e222a}
    .sys{background:#2a1f1f}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="/logo-192.png" alt="QD">
        <strong>Quantum Dashboard</strong>
        <span id="ver" class="pill">v?</span>
      </div>
      <div class="row">
        <button id="logout" class="btn sec">Wyloguj</button>
        <button id="install" class="btn sec">Zainstaluj PWA</button>
      </div>
    </header>

    <div id="lock" class="card">
      <h3>Wej≈õcie</h3>
      <p>Has≈Ço ekranu (UI): <code>przyja≈∫≈Ñ</code></p>
      <div class="row">
        <input id="pw" type="password" placeholder="has≈Ço‚Ä¶"/>
        <button id="go">Wejd≈∫</button>
      </div>
      <small class="muted">To tylko blokada UI. G≈Ç√≥wne uwierzytelnianie: cookie ustawiane po wej≈õciu z parametrem <code>?token=‚Ä¶</code>.</small>
    </div>

    <div id="app" class="hidden">
      <div class="grid">
        <section class="card half">
          <h3>üì¶ Projekty</h3>
          <div class="row">
            <input id="entry" placeholder="URL projektu (entry)‚Ä¶">
            <button id="add">Dodaj</button>
            <button id="sync">üîÅ Sync z KV</button>
            <button id="export">‚¨áÔ∏è Export JSON</button>
            <input id="importFile" type="file" accept="application/json" class="hidden">
            <button id="import">‚¨ÜÔ∏è Import JSON</button>
          </div>
          <div id="list"></div>
        </section>

        <section class="card half">
          <h3>üß∞ Akcje (asystent ‚Äì webhook/HEAD/KV)</h3>
          <div class="row">
            <input id="verifyUrl" placeholder="https://‚Ä¶ (HEAD)">
            <button id="verifyBtn">Sprawd≈∫ HEAD</button>
          </div>
          <div class="row">
            <input id="hookUrl" placeholder="Webhook URL (deploy/CI)">
            <input id="hookSecret" placeholder="Sekretny nag≈Ç√≥wek (opcjonalnie)">
            <button id="hookBtn">Wy≈õlij webhook</button>
          </div>
          <pre id="assistLog"></pre>
        </section>

        <section class="card">
          <h3>ü§ù Czat AI (PRO ‚Äì multi-provider)</h3>
          <div class="row">
            <select id="aiProvider">
              <option value="">(ENV)</option>
              <option value="anthropic">Anthropic (Claude)</option>
              <option value="openai">OpenAI</option>
              <option value="google">Google (Gemini)</option>
              <option value="mistral">Mistral</option>
              <option value="openrouter">OpenRouter</option>
              <option value="ollama">Ollama (lokalnie)</option>
            </select>
            <input id="aiModel" placeholder="model (opcjonalnie ‚Äì mo≈ºna zostawiƒá puste, u≈ºyje ENV)">
            <input id="aiTemp" type="number" step="0.1" min="0" max="2" value="0.2" style="max-width:120px">
          </div>
          <div class="chatlog" id="chatLog"></div>
          <div class="row">
            <input id="userMsg" placeholder="Napisz wiadomo≈õƒá i ENTER">
            <button id="send">Wy≈õlij</button>
            <button id="clearChat" class="btn sec">Wyczy≈õƒá</button>
            <button id="saveAI" class="btn sec">Zapisz do KV</button>
            <button id="loadAI" class="btn sec">Wczytaj z KV</button>
            <button id="exportAI" class="btn sec">Export .json</button>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // PWA
    if ("serviceWorker" in navigator) { navigator.serviceWorker.register("/sw.js").catch(()=>{}); }
    let deferredPrompt=null;
    window.addEventListener("beforeinstallprompt",(e)=>{ e.preventDefault(); deferredPrompt=e; });
    document.getElementById("install").onclick=async()=>{
      if(!deferredPrompt) return alert("PWA ju≈º zainstalowana lub niedostƒôpna");
      deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;
    };

    // wersja
    fetch("/version").then(r=>r.json()).then(v=>{
      document.getElementById("ver").textContent = "v"+(v.version||"?");
      // podpowied≈∫ providera/modelu z ENV:
      if (v.ai) {
        if (v.ai.provider) document.getElementById("aiProvider").querySelector(`option[value="${v.ai.provider}"]`)?.setAttribute("selected","selected");
        if (v.ai.model) document.getElementById("aiModel").placeholder = v.ai.model+" (ENV)";
      }
    });

    // UI lock
    const lock = document.getElementById("lock");
    const app  = document.getElementById("app");
    const go = document.getElementById("go");
    const pw = document.getElementById("pw");
    function openIfOk(){
      if (pw.value.trim() === "przyja≈∫≈Ñ") {
        lock.classList.add("hidden"); app.classList.remove("hidden");
        localStorage.setItem("qdp-ui-ok","1");
      } else { alert("Z≈Çe has≈Ço (podpowied≈∫: przyja≈∫≈Ñ)"); }
    }
    go.onclick=openIfOk; pw.onkeydown=(e)=>{ if(e.key==="Enter") openIfOk(); };
    if (localStorage.getItem("qdp-ui-ok")==="1") { lock.classList.add("hidden"); app.classList.remove("hidden"); }
    document.getElementById("logout").onclick=()=>{ localStorage.removeItem("qdp-ui-ok"); location.reload(); };

    // PROJEKTY
    const list = document.getElementById("list");
    const entry = document.getElementById("entry");
    let projects = [];
    function renderProjects() {
      list.innerHTML = "";
      projects.forEach((p,i)=>{
        const row = document.createElement("div");
        row.className="row";
        row.innerHTML = `
          <span class="pill">${p.name||"Bez nazwy"}</span>
          <a class="btn sec" href="${p.entry}" target="_blank">‚ñ∂ Otw√≥rz</a>
          <button class="btn sec" data-i="${i}" data-act="edit">‚úèÔ∏è</button>
          <button class="btn sec" data-i="${i}" data-act="del">üóëÔ∏è</button>
        `;
        list.appendChild(row);
      });
    }
    function saveProjLocal(){ localStorage.setItem("qdp-projects", JSON.stringify(projects)); }
    function loadProjLocal(){ projects = JSON.parse(localStorage.getItem("qdp-projects")||"[]"); renderProjects(); }
    loadProjLocal();
    document.getElementById("add").onclick=()=>{
      const url = entry.value.trim(); if(!url) return;
      projects.push({ name: "Custom", entry: url, category: "app", ts: Date.now() });
      entry.value=""; saveProjLocal(); renderProjects();
    };
    list.onclick=(e)=>{
      const btn = e.target.closest("button"); if(!btn) return;
      const i=+btn.dataset.i, act=btn.dataset.act;
      if (act==="del") { projects.splice(i,1); saveProjLocal(); renderProjects(); }
      if (act==="edit") {
        const np = prompt("Nazwa projektu:", projects[i].name||"");
        if (np!=null) { projects[i].name=np; saveProjLocal(); renderProjects(); }
      }
    };
    document.getElementById("export").onclick=()=>{
      const a=document.createElement("a");
      a.href="data:application/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(projects,null,2));
      a.download="projects.json"; a.click();
    };
    const importFile = document.getElementById("importFile");
    document.getElementById("import").onclick=()=>importFile.click();
    importFile.onchange=async()=>{
      const file = importFile.files[0]; if(!file) return;
      const txt = await file.text(); projects = JSON.parse(txt); saveProjLocal(); renderProjects();
    };
    document.getElementById("sync").onclick=async()=>{
      const r = await fetch("/api/kv/projects", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify(projects) });
      if (!r.ok) return alert("KV sync: b≈ÇƒÖd (wejd≈∫ przez ?token=‚Ä¶ i sprawd≈∫ ENV)");
      alert("Zsynchronizowano z KV");
    };
    (async()=>{
      const r = await fetch("/api/kv/projects"); if(r.ok){
        const j = await r.json(); if (j && j.value) { projects=j.value; saveProjLocal(); renderProjects(); }
      }
    })();

    // AKCJE (assist)
    const assistLog = document.getElementById("assistLog");
    function logAssist(x){ assistLog.textContent = (typeof x==="string")? x : JSON.stringify(x,null,2); }
    document.getElementById("verifyBtn").onclick=async()=>{
      const url = document.getElementById("verifyUrl").value.trim(); if(!url) return;
      const r = await fetch("/api/assist/run", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ action:"projects.verifyHead", params:{ url } }) });
      logAssist(await r.json());
    };
    document.getElementById("hookBtn").onclick=async()=>{
      const url = document.getElementById("hookUrl").value.trim();
      const secret = document.getElementById("hookSecret").value.trim();
      if(!url) return;
      const r = await fetch("/api/assist/run", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ action:"deploy.webhook", params:{ url, secret } }) });
      logAssist(await r.json());
    };

    // CZAT AI (pe≈Çny)
    const chatLog = document.getElementById("chatLog");
    const userMsg = document.getElementById("userMsg");
    const aiProvider = document.getElementById("aiProvider");
    const aiModel = document.getElementById("aiModel");
    const aiTemp = document.getElementById("aiTemp");
    const btnSend = document.getElementById("send");
    const btnClear = document.getElementById("clearChat");
    const btnSaveAI = document.getElementById("saveAI");
    const btnLoadAI = document.getElementById("loadAI");
    const btnExportAI = document.getElementById("exportAI");

    let messages = JSON.parse(localStorage.getItem("qdp-ai-messages")||"[]");
    if (!messages.length) {
      messages = [{ role:"system", content:"You are a senior engineer-assistant. Be concise, practical, and production-focused." }];
    }
    function renderAI(){
      chatLog.innerHTML="";
      messages.forEach(m=>{
        const div=document.createElement("div");
        div.className="msg "+(m.role==="user"?"user":(m.role==="assistant"?"assistant":"sys"));
        div.textContent = (m.role.toUpperCase()+": "+m.content);
        chatLog.appendChild(div);
      });
      chatLog.scrollTop = chatLog.scrollHeight;
      localStorage.setItem("qdp-ai-messages", JSON.stringify(messages));
    }
    renderAI();

    async function sendAI() {
      const content = userMsg.value.trim(); if(!content) return;
      messages.push({ role:"user", content }); userMsg.value=""; renderAI();
      const body = {
        messages,
        provider: aiProvider.value || undefined,
        model: aiModel.value || undefined,
        temperature: parseFloat(aiTemp.value||"0.2")
      };
      const res = await fetch("/api/ai/chat", {
        method:"POST", headers:{ "content-type":"application/json" },
        body: JSON.stringify(body)
      });
      const j = await res.json();
      if (!j.ok) { messages.push({ role:"assistant", content:`[B≈ÇƒÖd AI: ${j.err||'unknown'}]` }); renderAI(); return; }
      messages.push({ role:"assistant", content: j.text || "(pusty wynik)" }); renderAI();
    }
    btnSend.onclick=sendAI;
    userMsg.addEventListener("keydown",(e)=>{ if(e.key==="Enter") sendAI(); });
    btnClear.onclick=()=>{ messages=[{ role:"system", content:"You are a senior engineer-assistant. Be concise, practical, and production-focused." }]; renderAI(); };
    btnSaveAI.onclick=async()=>{
      const r = await fetch("/api/kv/ai-chat", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify(messages) });
      alert(r.ok ? "Zapisano czat AI w KV" : "B≈ÇƒÖd KV (wejd≈∫ przez ?token=‚Ä¶)");
    };
    btnLoadAI.onclick=async()=>{
      const r = await fetch("/api/kv/ai-chat"); const j = await r.json();
      if (j && j.value) { messages = j.value; renderAI(); } else alert("Brak czatu AI w KV");
    };
    btnExportAI.onclick=()=>{
      const a=document.createElement("a");
      a.href="data:application/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(messages,null,2));
      a.download="ai-chat-history.json"; a.click();
    };
  </script>
</body>
</html>
