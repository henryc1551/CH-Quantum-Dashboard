<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>CH-Quantum Dashboard • WayPro</title>
  <link rel="manifest" href="/manifest.webmanifest"/>
  <link rel="stylesheet" href="/style.css"/>
  <link rel="icon" href="/icon-dark-192.png" sizes="192x192">
  <meta name="theme-color" content="#0b0f14">
  <style>
    /* lekki kosmetyk na tabelki/logi */
    .kvs{width:100%;border-collapse:separate;border-spacing:0 6px}
    .kvs td{padding:8px 10px;border:1px solid #213041;background:#10171f}
    .kvs td:first-child{opacity:.8;white-space:nowrap}
    .row.wrap>*{margin-bottom:6px}
    .switch{display:inline-flex;align-items:center;gap:.5rem}
  </style>
</head>
<body>
<header class="topbar">
  <div class="brand">
    <img src="/logo-dark.svg" alt="Quantum Logo" class="logo" id="logoImg"/>
    CH-Quantum <span class="badge">WayPro</span>
  </div>
  <nav class="nav">
    <button id="themeToggle" class="tab-btn" title="Dark/Light">🌓</button>
    <button class="tab-btn" data-tab="home">🏠</button>
    <button class="tab-btn" data-tab="chat">💬</button>
    <button class="tab-btn" data-tab="projects">📁</button>
    <button class="tab-btn" data-tab="files">🗂️</button>
    <button class="tab-btn" data-tab="tools">🧰</button>
    <button class="tab-btn" data-tab="billing">💳</button>
    <button class="tab-btn" data-tab="automation">⚡</button>
    <button class="tab-btn" data-tab="admin">⚙️</button>
  </nav>
</header>

<main>
  <!-- … tu pozostają Twoje sekcje HOME/CHAT/PROJECTS/FILES/TOOLS/BILLING/ADMIN … -->

  <section class="tab" id="tab-automation">
    <div class="grid">
      <div class="card">
        <h2>⚡ Automation Status</h2>
        <table class="kvs" id="autoTable">
          <tr><td>Wersja</td><td id="ver">—</td></tr>
          <tr><td>Cron (ostatni)</td><td id="cron">—</td></tr>
          <tr><td>ENV → Email</td><td id="envEmail">—</td></tr>
          <tr><td>ENV → License</td><td id="envLic">—</td></tr>
          <tr><td>ENV → Forward</td><td id="envFwd">—</td></tr>
          <tr><td>Overrides</td><td id="ovr">—</td></tr>
          <tr><td>Effective flags</td><td id="eff">—</td></tr>
          <tr><td>Liczniki</td><td id="cnt">—</td></tr>
        </table>
        <div class="row wrap" style="margin-top:.5rem">
          <label class="switch"><input type="checkbox" id="swEmail"/> Auto Email</label>
          <label class="switch"><input type="checkbox" id="swLic"/> Auto License</label>
          <label class="switch"><input type="checkbox" id="swFwd"/> Forward ERP/CRM</label>
          <button id="btnSaveAuto" class="btn">Zapisz</button>
        </div>
        <div class="row wrap" style="margin-top:.5rem">
          <input id="testEmailTo" placeholder="test@adres.com"/>
          <button id="btnTestEmail" class="btn ghost">Test email</button>
          <button id="btnTestForward" class="btn ghost">Test forward</button>
          <button id="btnCron" class="btn">Ping cron</button>
        </div>
        <pre id="autoOut" class="mono small"></pre>
      </div>

      <div class="card">
        <h2>🗄️ Najnowsze logi</h2>
        <div class="row wrap">
          <button class="btn ghost" data-list="orders">Zamówienia</button>
          <button class="btn ghost" data-list="invoices">Faktury</button>
          <button class="btn ghost" data-list="subs">Suby</button>
          <button class="btn ghost" data-list="emails">Maile</button>
          <button class="btn ghost" data-list="licenses">Licencje</button>
          <button class="btn ghost" data-list="events">Stripe events</button>
          <input id="listLimit" type="number" min="5" value="25" style="max-width:100px"/>
        </div>
        <pre id="listOut" class="mono small"></pre>
      </div>
    </div>
  </section>
</main>

<script>
const tabs=[...document.querySelectorAll(".tab-btn")];
const sections={home:tab("home"),chat:tab("chat"),projects:tab("projects"),files:tab("files"),tools:tab("tools"),billing:tab("billing"),automation:tab("automation"),admin:tab("admin")};
function tab(id){return document.getElementById("tab-"+id)}
tabs.forEach(btn=>btn.dataset.tab && btn.addEventListener("click",()=>{document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active")); (sections[btn.dataset.tab]||sections.home).classList.add("active");}));
const themeBtn=document.getElementById("themeToggle"), logoImg=document.getElementById("logoImg");
themeBtn.onclick=()=>{document.body.classList.toggle("light");const L=document.body.classList.contains("light");logoImg.src=L?"/logo-light.svg":"/logo-dark.svg";localStorage.setItem("theme",L?"light":"dark");};
if(localStorage.getItem("theme")==="light"){document.body.classList.add("light"); logoImg.src="/logo-light.svg";}

/* === AUTOMATION UI === */
async function loadAutomation(){
  const r = await fetch("/api/admin/automation"); const j = await r.json();
  if(!j.ok) throw new Error(j.error||"Automation error");
  const pretty = (o)=> typeof o==="object" ? JSON.stringify(o) : String(o);
  document.getElementById("ver").textContent = j.version;
  document.getElementById("cron").textContent = j.lastCron ? new Date(j.lastCron.now||j.lastCron.ts||Date.now()).toLocaleString() : "—";
  document.getElementById("envEmail").textContent = String(j.env.email);
  document.getElementById("envLic").textContent = String(j.env.license);
  document.getElementById("envFwd").textContent = String(j.env.forward);
  document.getElementById("ovr").textContent = pretty(j.overrides);
  document.getElementById("eff").textContent = pretty(j.flags);
  document.getElementById("cnt").textContent = pretty(j.counts);

  // set switches to EFFECTIVE values
  document.getElementById("swEmail").checked = !!j.flags.email;
  document.getElementById("swLic").checked = !!j.flags.license;
  document.getElementById("swFwd").checked = !!j.flags.forward;
  return j;
}
const autoOut = document.getElementById("autoOut");
document.getElementById("btnSaveAuto").onclick=async()=>{
  try{
    const body={ auto_email: document.getElementById("swEmail").checked, auto_license: document.getElementById("swLic").checked, forward: document.getElementById("swFwd").checked };
    const r=await fetch("/api/admin/automation",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(body)});
    const j=await r.json(); autoOut.textContent=JSON.stringify(j,null,2); await loadAutomation();
  }catch(e){ autoOut.textContent=String(e); }
};
document.getElementById("btnTestEmail").onclick=async()=>{
  try{
    const to=document.getElementById("testEmailTo").value.trim(); if(!to) return alert("Podaj adres");
    const r=await fetch("/api/admin/test/email",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({to})});
    autoOut.textContent=await r.text();
  }catch(e){ autoOut.textContent=String(e); }
};
document.getElementById("btnTestForward").onclick=async()=>{
  try{
    const r=await fetch("/api/admin/test/forward",{method:"POST"});
    autoOut.textContent=await r.text();
  }catch(e){ autoOut.textContent=String(e); }
};
document.getElementById("btnCron").onclick=async()=>{
  try{
    const r=await fetch("/api/admin/trigger/cron",{method:"POST"}); autoOut.textContent=await r.text(); await loadAutomation();
  }catch(e){ autoOut.textContent=String(e); }
};

// lists
const listOut=document.getElementById("listOut");
document.querySelectorAll('[data-list]').forEach(btn=>{
  btn.onclick=async()=>{
    try{
      const type=btn.getAttribute("data-list"); const limit=parseInt(document.getElementById("listLimit").value||"25",10);
      const r=await fetch(`/api/admin/list?type=${encodeURIComponent(type)}&limit=${limit}`);
      const j=await r.json(); listOut.textContent=JSON.stringify(j,null,2);
    }catch(e){ listOut.textContent=String(e); }
  };
});

// autoload when opening tab
const autoTabBtn = [...document.querySelectorAll(".tab-btn")].find(b=>b.dataset.tab==="automation");
autoTabBtn && autoTabBtn.addEventListener("click", loadAutomation);
// also load once on startup so masz od razu
loadAutomation().catch(()=>{});
</script>
</body>
</html>
